<!DOCTYPE html>

<script type="module">
let files = await fetch('/files').then(r => r.json());
let collections = {};
for (let path of files) {
  let parts = path.split('/');
  let collection = parts[1];
  if (!collections[collection])
    collections[collection] = {};
  let group;
  if (parts.length > 3)
    group = parts[2];
  else
    group = 'all';
  if (!collections[collection][group])
    collections[collection][group] = [];
  collections[collection][group].push(path);
}

let button = document.body.appendChild(document.createElement('button'));
button.textContent = 'Show rows';
button.addEventListener('click', e => {
  if (table.className == 'bycolumns') {
    table.className = 'byrows';
    button.textContent = 'Show columns';
  } else {
    table.className = 'bycolumns';
    button.textContent = 'Show rows';
  }
  displayCollection();
});

let currentcollection = null;

for (let collection in collections) {
  let button = document.body.appendChild(document.createElement('button'));
  button.textContent = collection;
  button.addEventListener('click', e => {
    currentcollection = collection;
    displayCollection();
    for (let otherbutton of document.getElementsByTagName('button'))
      otherbutton.disabled = false;
    button.disabled = true;
  });
}

let table = document.body.appendChild(document.createElement('table'));
table.className = 'bycolumns';

function displayCollection() {
  if (!currentcollection)
    return;
  let groups = collections[currentcollection];
  table.textContent = '';
  let tr;
  if (table.className == 'bycolumns')
    tr = table.appendChild(document.createElement('tr'));
  let mode = 0;
  let selected;
  let entries = Object.entries(groups);
  let foundempty = false;
  for (let [group, images] of entries)
    if (images.length == 0) {
      foundempty = true;
      break;
    }
  if (!foundempty)
    groups[`Group ${entries.length}`] = [];
  entries = Object.entries(groups);
  for (let [group, images] of entries) {
    if (table.className == 'byrows')
      tr = table.appendChild(document.createElement('tr'));
    let td = tr.appendChild(document.createElement('td'));
    td.title = group;
    for (let i = 0; i < 30; i++) {
      if (i >= images.length)
        break;
      let img = td.appendChild(document.createElement('img'));
      img.src = images[i];
      img.addEventListener('click', e => {
        console.log('img.click', img);
        if (mode != 0)
          return;
        mode = 1;
        selected = [group, images[i]];
        e.stopPropagation();
      });
    }
    td.addEventListener('click', e => {
      console.log('td.click', td);
      if (mode != 1)
        return;
      mode = 0;
      let [group, fname] = selected;
      //fetch('...') -- move selected to td.title on server

      let source = groups[group];
      let i = source.indexOf(fname);
      source.splice(i, 1);

      let target = groups[td.title];
      target.unshift(fname);

      displayCollection();
    });
  }
}
</script>

<style>
table.bycolumns {
  table-layout: fixed;
  width: 100%;
}

table.bycolumns td {
  border: 1px solid black;
  vertical-align: top;
}

table.bycolumns img {
  max-width: 50%;
}

table.byrows td {
  border: 1px solid black;
  height: 20vh;
  vertical-align: top;
  white-space: nowrap;
}

table.byrows img {
  height: 20vh;
}
</style>
